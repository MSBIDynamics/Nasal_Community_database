{% extends "admin/change_form.html" %}
{% load static i18n custom_filters %}

{% block field_sets %}
  {% for fieldset in adminform %}
    {% if fieldset.name == None %}
        {% include "admin/includes/fieldset.html" with heading_level=2 prefix="fieldset" id_prefix=0 id_suffix=forloop.counter0 %}
    {% endif %}
  {% endfor %}

  <div class="form-row">
    <div class="w-full">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Permissions</h2>
      
      <div class="mb-4">
        <input type="text" id="permission-search" placeholder="Search for permissions..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

        <div id="permissions-accordion" class="border border-gray-200 rounded-md bg-white">
            {% for app_label, models in grouped_permissions.items %}
            <div class="permission-app-group border-b border-gray-200">
                <button type="button" class="accordion-header w-full flex justify-between items-center p-4 text-left font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">
                <span>{{ app_label|humanize_name }}</span>
                <svg class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
                <div class="accordion-panel hidden p-4 pt-0">
                {% for model_name, permissions in models.items %}
                    <div class="permission-model-group mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-md font-semibold text-gray-800">{{ model_name }}</h4>
                        <label class="flex items-center text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" class="select-all-model-permissions h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                        Select all
                        </label>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 pl-2">
                        {% for perm in permissions %}
                        <label class="permission-item flex items-center font-normal text-sm text-gray-600 cursor-pointer">
                            <input type="checkbox" name="permissions" value="{{ perm.pk }}" 
                                class="model-permission h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3"
                                {% if perm.pk in selected_permission_ids %}checked{% endif %}>
                            <span>{{ perm.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    </div>
                {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
  </div>
{% endblock %}

{% block admin_change_form_document_ready %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.accordion-header').forEach(button => {
        button.addEventListener('click', () => {
          const panel = button.nextElementSibling;
          const icon = button.querySelector('svg');
          panel.classList.toggle('hidden');
          icon.classList.toggle('rotate-180');
        });
      });

      document.querySelectorAll('.select-all-model-permissions').forEach(selectAllCheckbox => {
        selectAllCheckbox.addEventListener('change', (e) => {
          const modelGroup = e.target.closest('.permission-model-group');
          const permissions = modelGroup.querySelectorAll('.model-permission');
          permissions.forEach(permissionCheckbox => {
            permissionCheckbox.checked = e.target.checked;
          });
        });
      });

      const searchInput = document.getElementById('permission-search');
      searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        
        document.querySelectorAll('.permission-item').forEach(item => {
          const label = item.querySelector('span').textContent.toLowerCase();
          const shouldShow = label.includes(searchTerm);
          item.style.display = shouldShow ? 'flex' : 'none';
        });

        document.querySelectorAll('.permission-model-group').forEach(modelGroup => {
            const visibleItems = Array.from(modelGroup.querySelectorAll('.permission-item')).filter(item => item.style.display !== 'none');
            modelGroup.style.display = visibleItems.length > 0 ? 'block' : 'none';
        });

        document.querySelectorAll('.permission-app-group').forEach(appGroup => {
            const visibleModels = Array.from(appGroup.querySelectorAll('.permission-model-group')).filter(item => item.style.display !== 'none');
            appGroup.style.display = visibleModels.length > 0 ? 'block' : 'none';
        });
      });
    });
  </script>
{% endblock %}